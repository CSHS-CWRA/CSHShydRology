---
title: "3. Plotting daily data with quality symbols -- the function ch_qa_hydrograph"
author: "CSHS hydRology Team"
date: "March 2021"
output: rmarkdown::word_document

vignette: >
  %\VignetteIndexEntry{data source differences}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(CSHShydRology)
library(tidyhydat)






data(HYDAT_list)
```

One of the key opportunities for users of the R-package __CSHShydRology__ is that users can tap into the computer functions that are used by other professionals across Canada.  Many of the functions have been developed by practitioners and researchers and are shared so that the entire community can perform analysis and interpretation based on the current state of the art.  

The current version of __CSHShydRology__ can be obtained from GitHub at https://github.com/CSHS-CWRA/CSHShydRology. It is planned to release the package through CRAN (https://cran.r-project.org/) later this year.


## The function `ch_qa_hydrograph()`


This article, which is written using Rmarkdown (cran.r-project.org/web/packages/rmarkdown/vignettes/rmarkdown.html), shows how to  plot daily streamflows obtained either from tidyhydat or ECDE showing the quality flags "SYM".  This function can duplicate the daily flow plot used in ECDE and some additional options.

1. the default ECDE plot
2. a ECDE plot with counts of symbols in legend.
3. a plot with a specific date range. You can choose to scale this range base on either the entire dataset (for comparing periods with the same y-axis), or have the y-axis  on the plot be based on the data in the selected range.

"
Note that all __CSHShydRology__ functions start with  `ch_`.



This vignette demonstrates the options of the  function `ch_qa_hydrograph()`. 

First, start by getting the data from an ECDE file in a working directory using `ch_read_ECDE_flows()`. The function only needs a dataframe of daily flow data that is obtained by reading a daily flow data file from ECDE , or __tidyhydat__.  Here `ch_read_ECDE_flows()` is used to get that dataframe.  


```{r, echo=TRUE}

# the target datafile  "05CK004_Daily_Flow_ts.csv" is available on zenondo 

url1 <- "https://zenodo.org/record/4612007/files/05CK004_Daily_Flow_ts.csv?download=1"

e05CK004<- ch_read_ECDE_flows(url1)

str(e05CK004)



```

Now that we have the daily flow data in this form we can demonstrate the function `ch_qa_hydrograph()`.  First, we want to get the plot in the same form as ECDE by not showing the counts of SYM codes `(cts=FALSE)`.


```{r, echo=TRUE, fig.width=6, fig.height=5 , fig.cap = "Figure 1. The daily streamflow plot as would be generated in ECDE."}

e_test <- ch_qa_hydrograph(e05CK004, cts=FALSE)



```

  

The function returns a list that contains [1] a character string of "StationID  StationName", [2] the start_date if provided, [3] the end_date if provided, [4] the total number of data points, and [5] the SYM_count  [Default, A, B, C, D, E].

```{r, echo=TRUE, fig.width=6, fig.height=5}

str(e_test)



```


The default mode of the function `ch_qa_hydrograph()`  is the same  plot but the count of each SYM in the dataset, and the number of missing observations is added to the the legend.


```{r, echo=TRUE,fig.width=6, fig.height=5, fig.cap = "Figure 2. The default plot provides counts of symbol codes and the number of missing days in the legend."}


m_test <- ch_qa_hydrograph(e05CK004)


```

There are also options that allow for selected date ranges and for keeping the y-axis scaling constant based on the entire dataset or allowing it to be rescaled for the selected range.  In the following, we provide start and end dates, and allow the y-axis to be scaled for this time period.

```{r, echo=TRUE,fig.width=6, fig.height=5, fig.cap = "Figure 3. Plot with code counts and the y-axis scaled based on this time period."}


sdate <- "1980-01-01"
edate <- "1999-12-31"
m_test <- ch_qa_hydrograph(e05CK004, st_date=sdate, end_date=edate)

```



We can also choose to make the plot maintain the y-axis scaling for the entire dataset we would be used to plot multiple time periods with the scaling.  A simple loop would let you do a series of five or ten year periods to allow closer inspection of the record.

```{r, echo=TRUE,fig.width=6, fig.height=5, fig.cap = "Figure 4. Plot with code counts for a selected time period with y-axis as for the entire dataset."}

m_test <- ch_qa_hydrograph(e05CK004, st_date=sdate, end_date=edate, rescale=TRUE)

```


Now we can look at the contents of `m_test` and see the details for this subset of the streamflow record.

```{r, echo=TRUE,fig.width=6, fig.height=5}


str(m_test)

```

The functions demonstrated here provides information about the quality of the dataset available to the users of __CSHShydRology__.


_Other articles in this series are available on the hydRology page of the CSHS GreyJay website:_   `https://cshs.cwra.org/greyjay/`



P.H.Whitfield 
