---
title: "Part 2. Accessing metadata from Water Survey of Canada's HYDAT Database"
author: "CSHS hydRology Team"
date: "March 2021"
output: rmarkdown::word_document

vignette: >
  %\VignetteIndexEntry{data source differences}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(CSHShydRology)
library(tidyhydat)



#source("C:/R-packages/CSHShydrology/R/ch_tidyhydat_ECDE.R")
#source("C:/R-packages/CSHShydrology/R/ch_get_ECDE_metadata.R")
#source("C:/R-packages/CSHShydrology/R/ch_read_ECDE_flows.R")
#source("C:/R-packages/CSHShydrology/R/ch_tidyhydat_ECDE_meta.R")
#source("C:/R-packages/CSHShydrology/R/ch_qa_hydrograph.R")
```


One of the key opportunities for users of the R-package __CSHShydRology__ is that users can tap into the computer functions that are used by other professionals across Canada. Many of the functions have been developed by practitioners and researchers and are shared so that the entire community can perform analysis and interpretation based on the current state of the art.
The current version of __CSHShydRology__ can be obtained from GitHub at https://github.com/CSHS-CWRA/CSHShydRology. It is planned to release the package through CRAN (https://cran.r-project.org/) later this year.


## How can you access metadata for Canada's hydrometric network using R?


This article, which is written using Rmarkdown (cran.r-project.org/web/packages/rmarkdown/vignettes/rmarkdown.html), shows how to obtain station metadata from the primary source which is the HYDAT database. The HYDAT database is updated quarterly which and that creates opportunities and risks.




There are many options, it is important to know who you are and what fits your needs. This is simply one important form of fitness for purpose. Is it important that you have the same data each time for your project? 

This article shows how to obtain station metadata from the HYDAT database in two different ways. HYDAT is updated quarterly and that creates opportunities and cautions.  There are two main approaches to doing this.  

1. Access using the r-package __tidyhydat__.  
2. Access using ECDataExplorer (ECDE) saving the station list to a comma-separated values (.csv) file.

ECdataExploere is available at:  
https://www.canada.ca/en/environment-climate-change/services/water-overview/quantity/monitoring/survey/data-products-services/explorer.html

Note that all __CSHShydRology__ functions start with  "ch_"


## ECDataExplorer (ECDE)

ECDE lets one save a text file list of favourite stations  In this example it is "FavHydatStations.tb0" which is the ECDE default.

The function ch_get_ECDE_metadata is used to convert the text file to a dataframe of tombstone details (metadata).  There is an option to save the dataframe as a .csv  file.

```{r, echo=TRUE}

 
 url2 <- "https://zenodo.org/record/4661591/files/FavHydatStations.tb0?download=1"

 e_meta0 <- ch_get_ECDE_metadata (url2)
# e_meta1 <- ch_get_ECDE_metadata(url2, writefile="study_metadata.csv")

str(e_meta0)
```

## __tidyhydat__

We can mimic the ECDE metadata by extracting metadata through __tidyhydat__ using the function ch_tidyhydat_ECDE_meta.  This function returns a list.  The first item is a dataframe similar to that obtained from ECDE, the second reports the HYDAT version and date, and the third item is a dataframe with all the metadata extracted from __tidyhydat__ and is slightly different as it contains some details currently not available through ECDE.

There is a fundamental difference between these sources of metadata as ECDE provides some summary information that we do not capture in this function, but both do have common tombstone data (Station, StationName, Latitude and Longitude, etc.).

```{r, echo=TRUE}

stations <-c("05BB001", "05BB003", "05BB004", "05BB005")
result <-  ch_tidyhydat_ECDE_meta(stations)
th_metadata <- result[1]
version <- result[2]
allmeta <-result[3]

str(th_metadata)


```


Both methods create a dataframe with the information that gets used in other ch_functions for  tiltes that include StationIS, StationName or plotting (Latutude and Longitude).

To use this dataframe as the source of metadata within __CSHShydRology__:

HYDAT_list  <- th_metadata

"HYDAT_list" is the designated name (for CSHShydRology) of the dataframe containing the station metadata. There is a default version of this dataframe, but it could be better to have a version that is  current  to your  project data.


 
## Always be careful when obtaining data from different sources or even the same source!



_Other articles in this series are available on the CSHS GreyJay website: URL._



P.H.Whitfield 