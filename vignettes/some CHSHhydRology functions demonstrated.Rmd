---
title: "Demonstration of selected CSHShydRology functions"
author: "CSHS hydRology Team"
date: "March 2021"
output: rmarkdown::word_document

vignette: >
  %\VignetteIndexEntry{Demo CSHS functions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}



---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(CSHShydRology)
library(tidyhydat)

#source("C:/R-packages/CSHShydrology/R/ch_tidyhydat_ECDE.R")
#source("C:/R-packages/CSHShydrology/R/ch_get_ECDE_metadata.R")
#source("C:/R-packages/CSHShydrology/R/ch_read_ECDE_flows.R")
#source("C:/R-packages/CSHShydrology/R/ch_tidyhydat_ECDE_meta.R")
source("C:/R-packages/CSHShydrology/R/ch_qa_hydrograph.R")
#source("C:/R-packages/CSHShydrology/R/ch_flow_raster_trend.R")
source("C:/R-packages/git_CSHShydrology/R/ch_flow_raster.R")
source("C:/R-packages/git_CSHShydrology/R/ch_sub_set_Years.R")
#source("C:/R-packages/CSHShydrology/R/ch_flow_raster_qa.R")
#source("C:/R-packages/CSHShydrology/R/ch_regime_plot.R")
#source("C:/R-packages/CSHShydrology/R/ch_axis_doy.R")
#source("C:/R-packages/CSHShydrology/R/ch_cut_block.R")
#source("C:/R-packages/CSHShydrology/R/ch_fdcurve.R")
#source("C:/R-packages/CSHShydrology/R/ch_binned_MannWhitney.R")
#source("C:/R-packages/CSHShydrology/R/ch_decades_plot.R")
#source("C:/R-packages/CSHShydrology/R/p_doys.R")

data(HYDAT_list)
```


One of the key opportunities for users of the R-package __CSHShydRology__ is that users can tap into the computer functions that are used by other professionals across Canada.  Many of the functions have been developed by practitioners and researchers and are shared so that the entire community can perform analysis and interpretation based on the current state of the art.  

The current version of __CSHShydRology__ can be obtained from GitHub at https://github.com/CSHS-CWRA/CSHShydRology. It is planned to release the package through CRAN (https://cran.r-project.org/) later this year.

One always needs to be careful when using data from these types of sources.  Sometimes, changes are made at the source and code developed for one version could be impacted by those changes.

You need to be aware that the HYDAT database is periodically updated and if your work or project depends on the same data being available you may need to approach this differently.  HYDAT is actually several linked databases and many parts change over time (quarterly) and provide a ‘snapshot’ for the current version. 

You can obtain ECDataExplorer at: https://www.canada.ca/en/environment-climate-change/services/water-overview/quantity/monitoring/survey/data-products-services/explorer.html

Note that all __CSHShydRology__ functions start with  "ch_

## Demonstration of some basic __CSHShydRology__ functions

This article, which is written using Rmarkdown (cran.r-project.org/web/packages/rmarkdown/vignettes/rmarkdown.html), shows how to obtain daily flow data from the primary source the HYDAT database. This database is updated quarterly which and that creates opportunities and risks. 


Vignettes are a good way to see how other people use code or how they intended code to be used. It is not always obvious 
what the author intended ... they understood how they intended the code to function but mis-communication is too easy.  It is pretty easy to outsmart yourself 
in this; even easier to do it to others unintentionally. I have a long list of war stories from packages that I have used
and where I found too much information or background was left out.  Sometimes that was the fault of the developer, and in other cases I was 
dabbling into things where I did not have full command of the lingo or things the authors took for granted.

First, I need to explain that research code is different from production code.  In production code, we are seeking to get
to an answer that we generally understand how it gets derived and that method is tested and accepted. In production code we expect that asking for an analysis will provide both the analysis and perhaps graphical output; here the focus is on the analytical process not the result.

In research code the functions are not so integrated. A research functions often does only one action, so the analysis is generally a sequence of actions. That will be evident in this vignette.

In this demonstration, I chose a station at random from ECDataExplorer.  ECDataExplorer is one method to access the data in the HYDAT database and that I use in my practice.  I make this choice over other perhaps simpler methods because most of my studies use stations that 
are selected based on attributes that can be found in ECDataExplorer, and I download the daily streamflow data files to a directory from 
which they can be read. I also download the metadata from these stations so that this is captured at the same time as the data.  In research practice, one needs to ensure that all analysis is reproducible, so I choose to avoid dynamic access to databases as they will change over time (quarterly), and often our projects take several years to complete. I simply do not want to be chasing a small changes in a result that occurred because a bit more data had been added to the database.

So, the station I chose 04JD005 PAGAWACHUAN RIVER AT HIGHWAY NO. 11 is in Northern Ontario. I downloaded from ECDataExplorer
selecting Flow, Daily, and Timeseries. It has continuous operation and both flow and level data and is unregulated. 
The file obtained is "04JD005_Daily_Flow_ts.csv" and it is stored on __Zenodo__.  In normal practice this would be a directory on your computer that would be referred to with a name that was quite specific and descriptive.

The first thing is to access the data.  Restriction on R-package sizes means storing data in the pacakge needs to be minimized, so we have sample data stored on __Zenodo__ that can be accessed directly.  We access one of these in this example. First we define a url for where the file is located and read it with the function ch_read_ECDE_flows to read the file. The function returns a dataframe that can be used in most __CSHShydRology__ functions.

```{r, echo=TRUE}

url  <- "https://zenodo.org/record/4612007/files/04JD005_Daily_Flow_ts.csv?download=1"
url1 <- "https://zenodo.org/record/4612007/files/05CK004_Daily_Flow_ts.csv?download=1"

#read the data file and name it e04JD005

e04JD005 <- ch_read_ECDE_flows(url)

# check some aspects of the dataframe

head(e04JD005)
str(e04JD005)


```
What this function has done is the following: [1] The last three lines in the data file which include the Water Survey DISCLAIMER are removed, [2] Historically, as a default r used to read character [chr] data as factors and that affected both ID and Date, [3] ID is now chr, [4] Date is in Date Format, and [5] the variable names are consistent with HYDAT. This is now a usable dataframe.  

ECDataExplorer lets you see a hydrograph of the daily flow data that we can recreate with the function ch_qa_hydrograph

```{r, fig.width=7, fig.height=4}

m_test <-ch_qa_hydrograph(e04JD005, cts=FALSE)

```

  Figure 1.   Typical daily flow hydrograph as in ECDE.
  
  This is a typical hydrograph. The colours show the presence of some quality flags, but I 
  find this form too time compressed.
  
  So I use a series of functions to look at the data in different ways. First a raster plot of the data shows many years of data an gives a differnet perspective than the previous plot.


```{r, echo=TRUE, fig.width=8, fig.height=6}

md <- ch_flow_raster(e04JD005)


```


Another alternative is to plot the magnitude of flows in greyscale and overlay these with the quality flags (SYM); this plot gives insight into data quality.

```{r, echo=TRUE,fig.width=8, fig.height=6}

md <- ch_flow_raster_qa(e04JD005)

```

Most years have backwater associated with ice cover and a couple of year with long periods of estimated flows. It is interesting that the backwater often extends into the high flows at the start of freshet, and in 2000 
there seems to be no ice cover. An analyst might want to query this with Water Survey of Canada.



Now we can look at othe data in some other ways. 

First a regime plot. The first regime plot is for a calendar year(wyear=1).  In the second version wyear=10 so the plot is for a water year starting on 1 October.  There is an option to produce a grayscale instead of a colour plot (colour=FALSE).

  

```{r, echo=TRUE,fig.width=7, fig.height=5}

mp <- ch_regime_plot(e04JD005, wyear=1)
mp <- ch_regime_plot(e04JD005, wyear=10)
                  

```


Next is a flow duration curve.  There are two options; the first "normal" changes the exceedance probability [x-axis] to a normal distribution.  The second "gust" allows the Gustard Curves to be removed.  For  more on the Gustard curves see:

Gustard, A., A. Bullock, and J.M. Dixon. 1992. Low flow estimation in the United Kingdom. Institute of Hydrology, 292. Wallingford: Institute of Hydrology.

```{r, echo=TRUE,fig.width=7, fig.height=5}


fdc <- ch_fdcurve(e04JD005 )

fdc <- ch_fdcurve(e04JD005, normal=TRUE , gust=FALSE)
```

# Leith and Whitfield (1998) and Whitfield and Cannon (2000a &b)

In the 1990's there were starting to be a few papers on impacts of climate change on hydrology.  Rory Leith and I 
spent a long time looking into how one could show differences is seasonal patterns as in much of BC mean, minimum, 
and maximum flows were not changing.  We could see shifts in monthly data that were not significant and daily flows 
were simply too noisy so we implemented a method of binning days together so we could compare a period of days from
one decade to another.  This is implemented in the function ch_binned_MannWhitney.  Alex Cannon and I then applied 
that method to all of Canada and my students and I later applied it to Arctic temperature and precipitation, Canadian climate date, and New Mexico streamflow. Significant increases (decreases) are shown by blue (red) symbols.


```{r, echo=TRUE, fig.width=7, fig.height=5}

range1 <- c(1980,1989)
range2 <- c(1990,1999)
mplot <- ch_binned_MannWhitney(e04JD005, step=5, range1, range2, ptest=0.05)
str(mplot)




 mp <- ch_decades_plot(mplot)
```

In 1999-2000+ there was a lot of public interest in this topic, as there is today.  One issue was that the public 
was not always able to grasp the details to see the big picture. So Alex and I created a polar version of the output that
lets the view see increases and decreases and statistical significance in sort of a cartoon. Red is used for significant decreases and blue for significant increases.

```{r, echo=TRUE,fig.width=10, fig.height=6}

mp <- ch_polar_plot(mplot)

```

# scanning for trends

We have also used Mann-Kendall for trend tests. The function raster_trends produces a raster plot of binned data, and does trend test across the entire period of years, and across bins of days of years. In the first case step=5 and in the second step=11

```{r, echo=TRUE, fig.width=7, fig.height=6}

tr <- ch_flow_raster_trend(e04JD005, step=5)
tr <- ch_flow_raster_trend(e04JD005, step=11)

```

These results are interesting because Mann-Whitney shows no change but raster_plot that uses Mann_Kendall show two periods with
significant increases and two with significant decreases presumably due to longer records. Also, the annual minimum flow is showing a significant decrease. In the second case, where step =11 there is no longer a trend in the minimum.


One application is to do this for different river for the same time period. To do that we needs blocks 
of data for the same time periods.  That is where the function cut_block gets used. It take a dataset and returns all records
between a start and end date.



```{r, echo=TRUE, fig.width=7, fig.height=8}

cdata <-ch_cut_block(e04JD005, "2000/01/01","2010/12/31")

test_tr <- ch_flow_raster_trend(cdata, step=11)
```

The results for this case "test_tr" could be captured and compared to other rivers for the periods of the year or the trends over years.

```{r, echo=TRUE, fig.width=7, fig.height=8}

str(test_tr)


```
Get the p_values for the 33 periods of the year.

```{r, echo=TRUE, fig.width=7, fig.height=8}


## probability of Mann Kendall for periods
test_tr$prob_period




```

Get the values for the Mann-Kendall test for 11 maximum annual flows.


```{r, echo=TRUE, fig.width=7, fig.height=8}

## probability of Mann Kendall for maximum annual flow
test_tr$tau_maximum_year


```

_Other articles in this series are available on the CSHS GreyJay website: URL._

P.H. Whitfield
